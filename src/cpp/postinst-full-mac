#!/bin/bash

# ==============================================================================
# Lemonade System Post-Install Script
# ==============================================================================

# $2 is the target installation location (usually /). 
# The ${2%/} syntax ensures no trailing slash to prevent // paths.
INSTALL_ROOT="${2%/}"

SERVICE_LABEL="com.lemonade.server"
PLIST_DEST="${INSTALL_ROOT}/Library/LaunchDaemons/${SERVICE_LABEL}.plist"
LOG_DIR="${INSTALL_ROOT}/var/log/lemonade"
CONFIG_DIR="${INSTALL_ROOT}/usr/local/etc/lemonade"
APP_SUPPORT_DIR="${INSTALL_ROOT}/Library/Application Support/Lemonade"
LEMONADE_SHARE_DIR="${INSTALL_ROOT}/usr/local/share/lemonade-server"

echo "=== Starting Lemonade Post-Install ==="

# 1. UNLOAD OLD SERVICE
if launchctl list | grep -q "$SERVICE_LABEL"; then
    echo "Stopping existing service..."
    launchctl bootout system/"$SERVICE_LABEL" 2>/dev/null || launchctl unload "$PLIST_DEST" 2>/dev/null || true
    sleep 2
fi

# 2. SETUP DIRECTORIES
echo "Setting up system directories..."

mkdir -p "$CONFIG_DIR"
chmod 755 "$CONFIG_DIR"

# Log Directory (Required or service crashes)
mkdir -p "$LOG_DIR"
chmod 755 "$LOG_DIR"
chown root:wheel "$LOG_DIR"

# Share Directory
mkdir -p "$LEMONADE_SHARE_DIR"
chmod 755 "$LEMONADE_SHARE_DIR"
chown root:wheel "$LEMONADE_SHARE_DIR"

# 3. INSTALL RESOURCES
SOURCE_RES="${INSTALL_ROOT}/usr/local/resources"

if [ -d "$SOURCE_RES" ]; then
    echo "Moving resources to Application Support..."
    mkdir -p "$APP_SUPPORT_DIR"
    
    # Clean destination
    rm -rf "$APP_SUPPORT_DIR/"*
    # Copy fresh resources
    cp -R "$SOURCE_RES/"* "$APP_SUPPORT_DIR/"
    
    # Cleanup staging
    rm -rf "$SOURCE_RES"
    
    # Set permissions
    chmod -R 755 "$APP_SUPPORT_DIR"
    chown -R root:wheel "$APP_SUPPORT_DIR"
fi

# 4. SETUP BINARIES
APP_BINARY="${INSTALL_ROOT}/Applications/Lemonade.app/Contents/MacOS/Lemonade"
TARGET_LINK="${INSTALL_ROOT}/usr/local/bin/lemonade"

if [ -f "$APP_BINARY" ]; then
    echo "Linking 'lemonade' CLI..."
    mkdir -p "$(dirname "$TARGET_LINK")"
    ln -sf "$APP_BINARY" "$TARGET_LINK"
fi

# 5. SECURE PLIST (REFRESH)
if [ -f "$PLIST_DEST" ]; then
    echo "Securing Service Plist..."
    chown root:wheel "$PLIST_DEST"
    chmod 644 "$PLIST_DEST"
    xattr -c "$PLIST_DEST" 2>/dev/null || true
else
    echo "WARNING: Plist not found at $PLIST_DEST"
fi

# 6. RELOAD AND START
echo "Bootstrapping Service..."
launchctl bootstrap system "$PLIST_DEST" 2>/dev/null || launchctl load -w "$PLIST_DEST"
launchctl kickstart -k system/"$SERVICE_LABEL" 2>/dev/null || true

# 7. VERIFY
sleep 2
if launchctl list | grep -q "$SERVICE_LABEL"; then
    PID=$(launchctl list | grep "$SERVICE_LABEL" | awk '{print $1}')
    if [ "$PID" != "-" ]; then
        echo "SUCCESS: Service '$SERVICE_LABEL' is running (PID: $PID)."
    else
        echo "WARNING: Service loaded but not running."
    fi
fi

exit 0