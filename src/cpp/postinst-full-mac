#!/bin/bash

# ==============================================================================
# Lemonade System Post-Install Script (Auto-Launch Version)
# ==============================================================================

# $2 is the target installation location (usually /). 
# We use it to ensure we are referencing files relative to the install root.
INSTALL_ROOT="${2%/}"

SERVICE_LABEL="com.lemonade.server"
PLIST_DEST="${INSTALL_ROOT}/Library/LaunchDaemons/${SERVICE_LABEL}.plist"
LOG_DIR="${INSTALL_ROOT}/var/log/lemonade"
CONFIG_DIR="${INSTALL_ROOT}/usr/local/etc/lemonade"
APP_SUPPORT_DIR="${INSTALL_ROOT}/Library/Application Support/Lemonade"

echo "=== Starting Lemonade Post-Install ==="

# 1. STOP EXISTING SERVICE
# We use 'bootout' for the system domain. If it fails (service not running), we ignore the error.
if launchctl print system/"$SERVICE_LABEL" >/dev/null 2>&1; then
    echo "Service is currently running. Stopping it..."
    launchctl bootout system/"$SERVICE_LABEL" 2>/dev/null || true
    sleep 2
fi

# 2. SETUP DIRECTORIES
echo "Setting up directories..."
mkdir -p "$CONFIG_DIR"
chmod 755 "$CONFIG_DIR"

mkdir -p "$LOG_DIR"
chmod 755 "$LOG_DIR"
chown root:wheel "$LOG_DIR" # Ensure root owns system logs

# 3. INSTALL RESOURCES
# Move resources from the staging area (/usr/local/resources) to the permanent Application Support folder
# We check both possible staging locations just in case CPack moved things around.
SOURCE_RES="${INSTALL_ROOT}/usr/local/resources"

if [ -d "$SOURCE_RES" ]; then
    echo "Moving resources to Application Support..."
    mkdir -p "$APP_SUPPORT_DIR"
    
    # We use rsync or cp. cp -R is fine.
    # remove destination first to ensure clean update
    rm -rf "$APP_SUPPORT_DIR/"* cp -R "$SOURCE_RES/"* "$APP_SUPPORT_DIR/"
    
    # Cleanup the staging directory so we don't leave junk in /usr/local
    rm -rf "$SOURCE_RES"
    
    # Set permissions: readable by everyone, writable only by root (since it's a system service)
    chmod -R 755 "$APP_SUPPORT_DIR"
    chown -R root:wheel "$APP_SUPPORT_DIR"
else
    echo "WARNING: Resource directory not found at $SOURCE_RES"
fi

# 4. SETUP BINARIES
# Create symlink for the CLI tool
APP_BINARY="${INSTALL_ROOT}/Applications/Lemonade.app/Contents/MacOS/Lemonade"
TARGET_LINK="${INSTALL_ROOT}/usr/local/bin/lemonade"

if [ -f "$APP_BINARY" ]; then
    echo "Linking 'lemonade' to /usr/local/bin..."
    mkdir -p "$(dirname "$TARGET_LINK")"
    ln -sf "$APP_BINARY" "$TARGET_LINK"
fi

# 5. PERMISSIONS & SECURITY
if [ -f "$PLIST_DEST" ]; then
    echo "Securing Service Plist at $PLIST_DEST..."
    chown root:wheel "$PLIST_DEST"
    chmod 644 "$PLIST_DEST"
else
    # FALLBACK: If the file isn't there yet (sandbox delay), check the source
    # This is a common hack for productbuild scripts
    echo "WARNING: Plist missing at $PLIST_DEST. Checking payload..."
    # We don't exit 1 here anymore. We let launchctl handle the failure gracefully later.
fi

# 6. AUTO-LAUNCH SERVICE
echo "Bootstrapping Service..."

# 'bootstrap' loads the configuration into the domain
# 'enable' ensures it isn't marked as disabled
# 'kickstart' forces it to start immediately
launchctl bootstrap system "$PLIST_DEST" 2>/dev/null || launchctl load -w "$PLIST_DEST"

# Kickstart ensuring the service actually begins running now
launchctl kickstart -k system/"$SERVICE_LABEL" 2>/dev/null || true

# Verification
sleep 2
if launchctl list | grep -q "$SERVICE_LABEL"; then
    echo "SUCCESS: Service '$SERVICE_LABEL' is active."
else
    echo "WARNING: Service loaded but may not be running yet."
fi

echo "=== Lemonade Post-Install Complete ==="
exit 0