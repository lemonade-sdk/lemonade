#!/bin/bash

# Post-install script for the full Lemonade package (with Electron app)

INSTALL_DIR="$HOME/Library/Application Support/Lemonade"
LLAMA_DIR="${INSTALL_DIR}/llama"
APP_DIR="/Applications/Lemonade.app"

# Create llama directory if it doesn't exist and make it writable
mkdir -p "$LLAMA_DIR"
chmod 777 "$LLAMA_DIR"

# Make the Electron app executable
if [ -f "$APP_DIR/Contents/MacOS/Lemonade" ]; then
    chmod +x "$APP_DIR/Contents/MacOS/Lemonade"
fi

# Make other binaries executable (if any)
find "$APP_DIR/Contents/MacOS" -type f -exec chmod +x {} \; 2>/dev/null || true
find "$APP_DIR/Contents/Frameworks" -name "*.dylib" -type f -exec chmod 755 {} \; 2>/dev/null || true

# Install LaunchAgent for automatic startup (user-space service)
PLIST_SRC="$APP_DIR/Contents/Resources/com.lemonade.server.plist"
PLIST_DEST="$HOME/Library/LaunchAgents/com.lemonade.server.plist"
LOG_DIR="$HOME/Library/Logs"

if [ -f "$PLIST_SRC" ]; then
    echo "Installing Lemonade server as user LaunchAgent..."

    # Create log directory
    mkdir -p "$LOG_DIR"

    # Copy plist to LaunchAgents
    cp "$PLIST_SRC" "$PLIST_DEST"
    chmod 644 "$PLIST_DEST"

    # Load the service
    launchctl load -w "$PLIST_DEST"

    echo "Lemonade server LaunchAgent installed and loaded."
    echo "Configuration: $HOME/Library/Application Support/Lemonade/config.json"
    echo "Logs: $LOG_DIR/lemonade-server.*.log"
fi

exit 0
