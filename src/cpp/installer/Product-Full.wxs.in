<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  
  <!--
    Lemonade Full MSI Installer - WiX 5.0
    Version: @PROJECT_VERSION@ (auto-populated by CMake)
    Includes: Server components + Electron app
  -->
  
  <Package Name="Lemonade"
           Manufacturer="AMD"
           Version="@PROJECT_VERSION@"
           UpgradeCode="a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5f"
           Language="1033"
           Compressed="yes"
           Scope="perUser"
           InstallerVersion="500">
    
    <!-- Package metadata -->
    <SummaryInformation Description="Lemonade Local LLM Server with Desktop App"
                        Manufacturer="AMD"
                        Keywords="LLM, AI, Server, Local, Electron" />
    
    <!-- Icon for installer window and Add/Remove Programs -->
    <Icon Id="LemonadeIcon" SourceFile="$(var.SourceDir)\build\Release\resources\static\favicon.ico" />
    
    <!-- Set installer window icon -->
    <Property Id="ARPPRODUCTICON" Value="LemonadeIcon" />
    
    <!-- Also set as the main installer icon (shows in title bar and taskbar) -->
    <Property Id="SetupIcon" Value="LemonadeIcon" />
    
    <!-- Add/Remove Programs properties -->
    <Property Id="ARPHELPLINK" Value="https://lemonade-server.ai" />
    <Property Id="ARPURLINFOABOUT" Value="https://lemonade-server.ai" />
    
    <!-- Launch conditions -->
    <Launch Condition="VersionNT &gt;= 603"
            Message="This application requires Windows 8.1 or later." />
    
    <!-- Upgrade logic -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of Lemonade is already installed."
                  AllowSameVersionUpgrades="yes" />
    
    <!-- Custom properties for command-line installation -->
    <Property Id="ADDDESKTOPSHORTCUT" Value="1" />
    <Property Id="ADDTOSTARTUP" Value="0" Secure="yes" />
    <Property Id="LAUNCHAPP" Value="0" />

    <!-- Enable optional 'Run now' checkbox on ExitDialog (unchecked by default) -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Run Lemonade now" />

    <!-- Existing MSI-based install location (for in-place upgrades) -->
    <Property Id="EXISTINGINSTALLDIR">
      <RegistrySearch Id="FindInstallDir"
                      Root="HKCU"
                      Key="Software\AMD\Lemonade"
                      Name="InstallLocation"
                      Type="raw" />
    </Property>
    
    <!-- Detect legacy C++ NSIS-based installer location and uninstaller command -->
    <Property Id="NSISINSTALLED">
      <RegistrySearch Id="FindNsisInstall"
                      Root="HKCU"
                      Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\Lemonade Server"
                      Name="InstallLocation"
                      Type="raw" />
    </Property>
    
    <Property Id="NSISUNINSTALLSTRING">
      <RegistrySearch Id="FindNsisUninstall"
                      Root="HKCU"
                      Key="Software\Microsoft\Windows\CurrentVersion\Uninstall\Lemonade Server"
                      Name="UninstallString"
                      Type="raw" />
    </Property>
    
    <!-- Media -->
    <Media Id="1" Cabinet="lemonade.cab" EmbedCab="yes" />
    
    <!-- ============================================ -->
    <!-- Directory Structure -->
    <!-- ============================================ -->
    
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Id="INSTALLDIR" Name="lemonade">
        <Directory Id="BinDir" Name="bin">
          <Directory Id="ResourcesDir" Name="resources">
            <Directory Id="StaticDir" Name="static">
              <Directory Id="JsDir" Name="js" />
            </Directory>
            <Directory Id="DistDir" Name="dist">
              <Directory Id="BackendDir" Name="backend" />
              <Directory Id="RendererDir" Name="renderer" />
            </Directory>
          </Directory>
        </Directory>
        <Directory Id="LocalesDir" Name="locales" />
      </Directory>
    </StandardDirectory>
    
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ProgramMenuDir" Name="Lemonade" />
    </StandardDirectory>
    
    <StandardDirectory Id="DesktopFolder" />
    <StandardDirectory Id="StartupFolder" />
    
    <!-- ============================================ -->
    <!-- Components -->
    <!-- ============================================ -->
    
    <!-- Server Executable files -->
    <ComponentGroup Id="ExecutableComponents" Directory="BinDir">
      <Component Id="LemonadeTray" Guid="c3d4e5f6-a7b8-4c9d-0e1f-2a3b4c5d6e7f">
        <File Id="lemonade_tray.exe" Source="$(var.SourceDir)\build\Release\lemonade-tray.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="LemonadeServer" Guid="d4e5f6a7-b8c9-4d0e-1f2a-3b4c5d6e7f8a">
        <File Id="lemonade_server.exe" Source="$(var.SourceDir)\build\Release\lemonade-server.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="LemonadeRouter" Guid="e5f6a7b8-c9d0-4e1f-2a3b-4c5d6e7f8a9b">
        <File Id="lemonade_router.exe" Source="$(var.SourceDir)\build\Release\lemonade-router.exe" KeyPath="yes" />
      </Component>
      
      <Component Id="LemonadeLogViewer" Guid="f6a7b8c9-d0e1-4f2a-3b4c-5d6e7f8a9b0c">
        <File Id="lemonade_log_viewer.exe" Source="$(var.SourceDir)\build\Release\lemonade-log-viewer.exe" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Electron App Executable -->
    <ComponentGroup Id="ElectronAppComponents" Directory="BinDir">
      <Component Id="LemonadeElectronExe" Guid="1a2b3c4d-5e6f-7a8b-9c0d-1e2f3a4b5c6d">
        <File Id="Lemonade.exe" Source="$(var.SourceDir)\build\Release\Lemonade.exe" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Electron DLL files -->
    <ComponentGroup Id="ElectronDllComponents" Directory="BinDir">
      <Component Id="D3DCompilerDll" Guid="2b3c4d5e-6f7a-8b9c-0d1e-2f3a4b5c6d7e">
        <File Id="d3dcompiler_47.dll" Source="$(var.SourceDir)\build\Release\d3dcompiler_47.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="FfmpegDll" Guid="3c4d5e6f-7a8b-9c0d-1e2f-3a4b5c6d7e8f">
        <File Id="ffmpeg.dll" Source="$(var.SourceDir)\build\Release\ffmpeg.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="LibEGLDll" Guid="4d5e6f7a-8b9c-0d1e-2f3a-4b5c6d7e8f9a">
        <File Id="libEGL.dll" Source="$(var.SourceDir)\build\Release\libEGL.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="LibGLESv2Dll" Guid="5e6f7a8b-9c0d-1e2f-3a4b-5c6d7e8f9a0b">
        <File Id="libGLESv2.dll" Source="$(var.SourceDir)\build\Release\libGLESv2.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="VkSwiftshaderDll" Guid="6f7a8b9c-0d1e-2f3a-4b5c-6d7e8f9a0b1c">
        <File Id="vk_swiftshader.dll" Source="$(var.SourceDir)\build\Release\vk_swiftshader.dll" KeyPath="yes" />
      </Component>
      
      <Component Id="Vulkan1Dll" Guid="7a8b9c0d-1e2f-3a4b-5c6d-7e8f9a0b1c2d">
        <File Id="vulkan_1.dll" Source="$(var.SourceDir)\build\Release\vulkan-1.dll" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Electron Resource files (in BinDir) -->
    <ComponentGroup Id="ElectronResourceComponents" Directory="BinDir">
      <Component Id="Chrome100Pak" Guid="8b9c0d1e-2f3a-4b5c-6d7e-8f9a0b1c2d3e">
        <File Id="chrome_100_percent.pak" Source="$(var.SourceDir)\build\Release\chrome_100_percent.pak" KeyPath="yes" />
      </Component>
      
      <Component Id="Chrome200Pak" Guid="9c0d1e2f-3a4b-5c6d-7e8f-9a0b1c2d3e4f">
        <File Id="chrome_200_percent.pak" Source="$(var.SourceDir)\build\Release\chrome_200_percent.pak" KeyPath="yes" />
      </Component>
      
      <Component Id="IcudtlDat" Guid="0d1e2f3a-4b5c-6d7e-8f9a-0b1c2d3e4f5a">
        <File Id="icudtl.dat" Source="$(var.SourceDir)\build\Release\icudtl.dat" KeyPath="yes" />
      </Component>
      
      <Component Id="ResourcesPak" Guid="1e2f3a4b-5c6d-7e8f-9a0b-1c2d3e4f5a6b">
        <File Id="resources.pak" Source="$(var.SourceDir)\build\Release\resources.pak" KeyPath="yes" />
      </Component>
      
      <Component Id="SnapshotBlobBin" Guid="2f3a4b5c-6d7e-8f9a-0b1c-2d3e4f5a6b7c">
        <File Id="snapshot_blob.bin" Source="$(var.SourceDir)\build\Release\snapshot_blob.bin" KeyPath="yes" />
      </Component>
      
      <Component Id="V8ContextSnapshotBin" Guid="3a4b5c6d-7e8f-9a0b-1c2d-3e4f5a6b7c8d">
        <File Id="v8_context_snapshot.bin" Source="$(var.SourceDir)\build\Release\v8_context_snapshot.bin" KeyPath="yes" />
      </Component>
      
      <Component Id="VkSwiftshaderJson" Guid="4b5c6d7e-8f9a-0b1c-2d3e-4f5a6b7c8d9e">
        <File Id="vk_swiftshader_icd.json" Source="$(var.SourceDir)\build\Release\vk_swiftshader_icd.json" KeyPath="yes" />
      </Component>
      
      <Component Id="ElectronLicense" Guid="5c6d7e8f-9a0b-1c2d-3e4f-5a6b7c8d9e0f">
        <File Id="LICENSE.electron.txt" Source="$(var.SourceDir)\build\Release\LICENSE.electron.txt" KeyPath="yes" />
      </Component>
      
      <Component Id="ChromiumLicenses" Guid="6d7e8f9a-0b1c-2d3e-4f5a-6b7c8d9e0f1a">
        <File Id="LICENSES.chromium.html" Source="$(var.SourceDir)\build\Release\LICENSES.chromium.html" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- Server Resource files -->
    <ComponentGroup Id="ResourceComponents">
      <Component Id="ServerModelsJson" Directory="ResourcesDir" Guid="a8b9c0d1-e2f3-4a4b-5c6d-7e8f9a0b1c2d">
        <File Id="server_models.json" Source="$(var.SourceDir)\build\Release\resources\server_models.json" KeyPath="yes" />
      </Component>
      
      <Component Id="BackendVersionsJson" Directory="ResourcesDir" Guid="b9c0d1e2-f3a4-4b5c-6d7e-8f9a0b1c2d3e">
        <File Id="backend_versions.json" Source="$(var.SourceDir)\build\Release\resources\backend_versions.json" KeyPath="yes" />
      </Component>
      
      <Component Id="FaviconIco" Directory="StaticDir" Guid="c0d1e2f3-a4b5-4c6d-7e8f-9a0b1c2d3e4f">
        <File Id="favicon.ico" Source="$(var.SourceDir)\build\Release\resources\static\favicon.ico" KeyPath="yes" />
      </Component>
      
      <Component Id="LogsHtml" Directory="StaticDir" Guid="d1e2f3a4-b5c6-4d7e-8f9a-0b1c2d3e4f5a">
        <File Id="logs.html" Source="$(var.SourceDir)\build\Release\resources\static\logs.html" KeyPath="yes" />
      </Component>
      
      <Component Id="StylesCss" Directory="StaticDir" Guid="e2f3a4b5-c6d7-4e8f-9a0b-1c2d3e4f5a6b">
        <File Id="styles.css" Source="$(var.SourceDir)\build\Release\resources\static\styles.css" KeyPath="yes" />
      </Component>
      
      <Component Id="WebappHtml" Directory="StaticDir" Guid="f3a4b5c6-d7e8-4f9a-0b1c-2d3e4f5a6b7c">
        <File Id="webapp.html" Source="$(var.SourceDir)\build\Release\resources\static\webapp.html" KeyPath="yes" />
      </Component>
      
      <Component Id="ChatJs" Directory="JsDir" Guid="a4b5c6d7-e8f9-4a0b-1c2d-3e4f5a6b7c8d">
        <File Id="chat.js" Source="$(var.SourceDir)\build\Release\resources\static\js\chat.js" KeyPath="yes" />
      </Component>
      
      <Component Id="ModelSettingsJs" Directory="JsDir" Guid="b5c6d7e8-f9a0-4b1c-2d3e-4f5a6b7c8d9e">
        <File Id="model_settings.js" Source="$(var.SourceDir)\build\Release\resources\static\js\model-settings.js" KeyPath="yes" />
      </Component>
      
      <Component Id="ModelsJs" Directory="JsDir" Guid="c6d7e8f9-a0b1-4c2d-3e4f-5a6b7c8d9e0f">
        <File Id="models.js" Source="$(var.SourceDir)\build\Release\resources\static\js\models.js" KeyPath="yes" />
      </Component>
      
      <Component Id="SharedJs" Directory="JsDir" Guid="d7e8f9a0-b1c2-4d3e-4f5a-6b7c8d9e0f1a">
        <File Id="shared.js" Source="$(var.SourceDir)\build\Release\resources\static\js\shared.js" KeyPath="yes" />
      </Component>
      
      <!-- Electron App Resources -->
      <Component Id="AppAsar" Directory="ResourcesDir" Guid="7e8f9a0b-1c2d-3e4f-5a6b-7c8d9e0f1a2b">
        <File Id="app.asar" Source="$(var.SourceDir)\build\Release\resources\app.asar" KeyPath="yes" />
      </Component>
      
      <Component Id="ElevateExe" Directory="ResourcesDir" Guid="8f9a0b1c-2d3e-4f5a-6b7c-8d9e0f1a2b3c">
        <File Id="elevate.exe" Source="$(var.SourceDir)\build\Release\resources\elevate.exe" KeyPath="yes" />
      </Component>
      
      <!-- Backend Server Files -->
      <Component Id="BackendServerJs" Directory="BackendDir" Guid="9a0b1c2d-3e4f-5a6b-7c8d-9e0f1a2b3c4d">
        <File Id="server.js" Source="$(var.SourceDir)\build\Release\resources\dist\backend\server.js" KeyPath="yes" />
      </Component>
      
      <Component Id="BackendServerJsMap" Directory="BackendDir" Guid="0b1c2d3e-4f5a-6b7c-8d9e-0f1a2b3c4d5e">
        <File Id="server.js.map" Source="$(var.SourceDir)\build\Release\resources\dist\backend\server.js.map" KeyPath="yes" />
      </Component>
      
      <Component Id="BackendServerDTs" Directory="BackendDir" Guid="1c2d3e4f-5a6b-7c8d-9e0f-1a2b3c4d5e6f">
        <File Id="server.d.ts" Source="$(var.SourceDir)\build\Release\resources\dist\backend\server.d.ts" KeyPath="yes" />
      </Component>
      
      <Component Id="BackendServerDTsMap" Directory="BackendDir" Guid="2d3e4f5a-6b7c-8d9e-0f1a-2b3c4d5e6f7a">
        <File Id="server.d.ts.map" Source="$(var.SourceDir)\build\Release\resources\dist\backend\server.d.ts.map" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- 
      Renderer Components: 
      The renderer directory contains ~580 files which need to be included.
      
      For initial testing, you can build without renderer files and they will be copied
      to the build directory by the CopyElectronApp.cmake script.
      
      For production, harvest renderer files using WiX heat tool:
        wix extension add WixToolset.Heat.wixext
        wix heat directory "build\Release\resources\dist\renderer" 
            -cg RendererComponents 
            -dr RendererDir 
            -gg 
            -sfrag 
            -out installer\RendererComponents.wxs
      
      Then include in Product-Full.wxs and add <ComponentGroupRef Id="RendererComponents" /> to Feature.
    -->
    
    <!-- Placeholder: Renderer files copied via custom action -->
    <ComponentGroup Id="RendererComponents" Directory="RendererDir">
      <!-- Renderer files (~580 files) are copied via CopyRendererFiles custom action -->
      <!-- This avoids having to enumerate all files in WiX -->
      <Component Id="RendererDirMarker" Guid="a1a2a3a4-b5b6-c7c8-d9d0-e1e2e3e4e5e6">
        <RegistryValue Root="HKCU" Key="Software\AMD\Lemonade" Name="RendererInstalled" Type="integer" Value="1" KeyPath="yes" />
        <RemoveFolder Id="RemoveRendererDir" On="uninstall" />
      </Component>
    </ComponentGroup>
    
    <!-- Locales files (all language packs) -->
    <ComponentGroup Id="LocalesComponents" Directory="LocalesDir">
      <Component Id="LocaleAf" Guid="00000000-0000-0000-e8f9-a0b1c2d35247">
        <File Id="af_pak" Source="$(var.SourceDir)\build\Release\locales\af.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleAm" Guid="00000000-0000-0000-e8f9-a0b1c2d35248">
        <File Id="am_pak" Source="$(var.SourceDir)\build\Release\locales\am.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleAr" Guid="00000000-0000-0000-e8f9-a0b1c2d35249">
        <File Id="ar_pak" Source="$(var.SourceDir)\build\Release\locales\ar.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleBg" Guid="00000000-0000-0000-e8f9-a0b1c2d3524a">
        <File Id="bg_pak" Source="$(var.SourceDir)\build\Release\locales\bg.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleBn" Guid="00000000-0000-0000-e8f9-a0b1c2d3524b">
        <File Id="bn_pak" Source="$(var.SourceDir)\build\Release\locales\bn.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleCa" Guid="00000000-0000-0000-e8f9-a0b1c2d3524c">
        <File Id="ca_pak" Source="$(var.SourceDir)\build\Release\locales\ca.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleCs" Guid="00000000-0000-0000-e8f9-a0b1c2d3524d">
        <File Id="cs_pak" Source="$(var.SourceDir)\build\Release\locales\cs.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleDa" Guid="00000000-0000-0000-e8f9-a0b1c2d3524e">
        <File Id="da_pak" Source="$(var.SourceDir)\build\Release\locales\da.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleDe" Guid="00000000-0000-0000-e8f9-a0b1c2d3524f">
        <File Id="de_pak" Source="$(var.SourceDir)\build\Release\locales\de.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleEl" Guid="00000000-0000-0000-e8f9-a0b1c2d35250">
        <File Id="el_pak" Source="$(var.SourceDir)\build\Release\locales\el.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleEnGb" Guid="00000000-0000-0000-e8f9-a0b1c2d35251">
        <File Id="en_GB_pak" Source="$(var.SourceDir)\build\Release\locales\en-GB.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleEnUs" Guid="00000000-0000-0000-e8f9-a0b1c2d35252">
        <File Id="en_US_pak" Source="$(var.SourceDir)\build\Release\locales\en-US.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleEs419" Guid="00000000-0000-0000-e8f9-a0b1c2d35253">
        <File Id="es_419_pak" Source="$(var.SourceDir)\build\Release\locales\es-419.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleEs" Guid="00000000-0000-0000-e8f9-a0b1c2d35254">
        <File Id="es_pak" Source="$(var.SourceDir)\build\Release\locales\es.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleEt" Guid="00000000-0000-0000-e8f9-a0b1c2d35255">
        <File Id="et_pak" Source="$(var.SourceDir)\build\Release\locales\et.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleFa" Guid="00000000-0000-0000-e8f9-a0b1c2d35256">
        <File Id="fa_pak" Source="$(var.SourceDir)\build\Release\locales\fa.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleFi" Guid="00000000-0000-0000-e8f9-a0b1c2d35257">
        <File Id="fi_pak" Source="$(var.SourceDir)\build\Release\locales\fi.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleFil" Guid="00000000-0000-0000-e8f9-a0b1c2d35258">
        <File Id="fil_pak" Source="$(var.SourceDir)\build\Release\locales\fil.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleFr" Guid="00000000-0000-0000-e8f9-a0b1c2d35259">
        <File Id="fr_pak" Source="$(var.SourceDir)\build\Release\locales\fr.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleGu" Guid="00000000-0000-0000-e8f9-a0b1c2d3525a">
        <File Id="gu_pak" Source="$(var.SourceDir)\build\Release\locales\gu.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleHe" Guid="00000000-0000-0000-e8f9-a0b1c2d3525b">
        <File Id="he_pak" Source="$(var.SourceDir)\build\Release\locales\he.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleHi" Guid="00000000-0000-0000-e8f9-a0b1c2d3525c">
        <File Id="hi_pak" Source="$(var.SourceDir)\build\Release\locales\hi.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleHr" Guid="00000000-0000-0000-e8f9-a0b1c2d3525d">
        <File Id="hr_pak" Source="$(var.SourceDir)\build\Release\locales\hr.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleHu" Guid="00000000-0000-0000-e8f9-a0b1c2d3525e">
        <File Id="hu_pak" Source="$(var.SourceDir)\build\Release\locales\hu.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleId" Guid="00000000-0000-0000-e8f9-a0b1c2d3525f">
        <File Id="id_pak" Source="$(var.SourceDir)\build\Release\locales\id.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleIt" Guid="00000000-0000-0000-e8f9-a0b1c2d35260">
        <File Id="it_pak" Source="$(var.SourceDir)\build\Release\locales\it.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleJa" Guid="00000000-0000-0000-e8f9-a0b1c2d35261">
        <File Id="ja_pak" Source="$(var.SourceDir)\build\Release\locales\ja.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleKn" Guid="00000000-0000-0000-e8f9-a0b1c2d35262">
        <File Id="kn_pak" Source="$(var.SourceDir)\build\Release\locales\kn.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleKo" Guid="00000000-0000-0000-e8f9-a0b1c2d35263">
        <File Id="ko_pak" Source="$(var.SourceDir)\build\Release\locales\ko.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleLt" Guid="00000000-0000-0000-e8f9-a0b1c2d35264">
        <File Id="lt_pak" Source="$(var.SourceDir)\build\Release\locales\lt.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleLv" Guid="00000000-0000-0000-e8f9-a0b1c2d35265">
        <File Id="lv_pak" Source="$(var.SourceDir)\build\Release\locales\lv.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleMl" Guid="00000000-0000-0000-e8f9-a0b1c2d35266">
        <File Id="ml_pak" Source="$(var.SourceDir)\build\Release\locales\ml.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleMr" Guid="00000000-0000-0000-e8f9-a0b1c2d35267">
        <File Id="mr_pak" Source="$(var.SourceDir)\build\Release\locales\mr.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleMs" Guid="00000000-0000-0000-e8f9-a0b1c2d35268">
        <File Id="ms_pak" Source="$(var.SourceDir)\build\Release\locales\ms.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleNb" Guid="00000000-0000-0000-e8f9-a0b1c2d35269">
        <File Id="nb_pak" Source="$(var.SourceDir)\build\Release\locales\nb.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleNl" Guid="00000000-0000-0000-e8f9-a0b1c2d3526a">
        <File Id="nl_pak" Source="$(var.SourceDir)\build\Release\locales\nl.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocalePl" Guid="00000000-0000-0000-e8f9-a0b1c2d3526b">
        <File Id="pl_pak" Source="$(var.SourceDir)\build\Release\locales\pl.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocalePtBr" Guid="00000000-0000-0000-e8f9-a0b1c2d3526c">
        <File Id="pt_BR_pak" Source="$(var.SourceDir)\build\Release\locales\pt-BR.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocalePtPt" Guid="00000000-0000-0000-e8f9-a0b1c2d3526d">
        <File Id="pt_PT_pak" Source="$(var.SourceDir)\build\Release\locales\pt-PT.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleRo" Guid="00000000-0000-0000-e8f9-a0b1c2d3526e">
        <File Id="ro_pak" Source="$(var.SourceDir)\build\Release\locales\ro.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleRu" Guid="00000000-0000-0000-e8f9-a0b1c2d3526f">
        <File Id="ru_pak" Source="$(var.SourceDir)\build\Release\locales\ru.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleSk" Guid="00000000-0000-0000-e8f9-a0b1c2d35270">
        <File Id="sk_pak" Source="$(var.SourceDir)\build\Release\locales\sk.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleSl" Guid="00000000-0000-0000-e8f9-a0b1c2d35271">
        <File Id="sl_pak" Source="$(var.SourceDir)\build\Release\locales\sl.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleSr" Guid="00000000-0000-0000-e8f9-a0b1c2d35272">
        <File Id="sr_pak" Source="$(var.SourceDir)\build\Release\locales\sr.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleSv" Guid="00000000-0000-0000-e8f9-a0b1c2d35273">
        <File Id="sv_pak" Source="$(var.SourceDir)\build\Release\locales\sv.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleSw" Guid="00000000-0000-0000-e8f9-a0b1c2d35274">
        <File Id="sw_pak" Source="$(var.SourceDir)\build\Release\locales\sw.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleTa" Guid="00000000-0000-0000-e8f9-a0b1c2d35275">
        <File Id="ta_pak" Source="$(var.SourceDir)\build\Release\locales\ta.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleTe" Guid="00000000-0000-0000-e8f9-a0b1c2d35276">
        <File Id="te_pak" Source="$(var.SourceDir)\build\Release\locales\te.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleTh" Guid="00000000-0000-0000-e8f9-a0b1c2d35277">
        <File Id="th_pak" Source="$(var.SourceDir)\build\Release\locales\th.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleTr" Guid="00000000-0000-0000-e8f9-a0b1c2d35278">
        <File Id="tr_pak" Source="$(var.SourceDir)\build\Release\locales\tr.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleUk" Guid="00000000-0000-0000-e8f9-a0b1c2d35279">
        <File Id="uk_pak" Source="$(var.SourceDir)\build\Release\locales\uk.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleUr" Guid="00000000-0000-0000-e8f9-a0b1c2d3527a">
        <File Id="ur_pak" Source="$(var.SourceDir)\build\Release\locales\ur.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleVi" Guid="00000000-0000-0000-e8f9-a0b1c2d3527b">
        <File Id="vi_pak" Source="$(var.SourceDir)\build\Release\locales\vi.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleZhCn" Guid="00000000-0000-0000-e8f9-a0b1c2d3527c">
        <File Id="zh_CN_pak" Source="$(var.SourceDir)\build\Release\locales\zh-CN.pak" KeyPath="yes" />
      </Component>

      <Component Id="LocaleZhTw" Guid="00000000-0000-0000-e8f9-a0b1c2d3527d">
        <File Id="zh_TW_pak" Source="$(var.SourceDir)\build\Release\locales\zh-TW.pak" KeyPath="yes" />
      </Component>
    </ComponentGroup>
    
    <!-- PATH environment variable -->
    <Component Id="PathEnvironment" Directory="BinDir" Guid="a1b2c3d4-e5f6-4a7b-8c9d-0e1f2a3b4c5d">
      <Environment Id="PATH" Name="PATH" Value="[BinDir]" Action="set" Part="last" System="no" />
      <RegistryValue Root="HKCU" Key="Software\AMD\Lemonade" Name="PathSet" Type="integer" Value="1" KeyPath="yes" />
    </Component>
    
    <!-- Registry keys -->
    <Component Id="RegistryEntries" Directory="INSTALLDIR" Guid="b2c3d4e5-f6a7-4b8c-9d0e-1f2a3b4c5d6e">
      <RegistryKey Root="HKCU" Key="Software\AMD\Lemonade">
        <RegistryValue Type="string" Name="InstallLocation" Value="[INSTALLDIR]" KeyPath="yes" />
        <RegistryValue Type="string" Name="Version" Value="@PROJECT_VERSION@" />
        <RegistryValue Type="integer" Name="Startup" Value="[ADDTOSTARTUP]" />
      </RegistryKey>
    </Component>
    
    <!-- Start Menu shortcuts -->
    <Component Id="ProgramMenuShortcuts" Directory="ProgramMenuDir" Guid="a7b8c9d0-e1f2-4a3b-4c5d-6e7f8a9b0c1d">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="Lemonade"
                Target="[BinDir]Lemonade.exe"
                WorkingDirectory="BinDir"
                Icon="LemonadeIcon" />
      <Shortcut Id="ServerStartMenuShortcut"
                Name="Lemonade Server (Tray)"
                Target="[BinDir]lemonade-tray.exe"
                WorkingDirectory="BinDir"
                Icon="LemonadeIcon" />
      <Shortcut Id="UninstallShortcut"
                Name="Uninstall Lemonade"
                Target="[SystemFolder]msiexec.exe"
                Arguments="/x [ProductCode]" />
      <RemoveFolder Id="RemoveProgramMenuDir" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\AMD\Lemonade" Name="StartMenu" Type="integer" Value="1" KeyPath="yes" />
    </Component>
    
    <!-- Desktop shortcut (conditional) -->
    <Component Id="DesktopShortcut" Directory="DesktopFolder" Guid="c9d0e1f2-a3b4-4c5d-6e7f-8a9b0c1d2e3f" Condition="ADDDESKTOPSHORTCUT = 1">
      <Shortcut Id="DesktopShortcutId"
                Name="Lemonade"
                Target="[BinDir]Lemonade.exe"
                WorkingDirectory="BinDir"
                Icon="LemonadeIcon" />
      <RegistryValue Root="HKCU" Key="Software\AMD\Lemonade" Name="Desktop" Type="integer" Value="1" KeyPath="yes" />
    </Component>
    
    <!-- ============================================ -->
    <!-- Features -->
    <!-- ============================================ -->
    
    <Feature Id="Complete" Level="1">
      <ComponentGroupRef Id="ExecutableComponents" />
      <ComponentGroupRef Id="ElectronAppComponents" />
      <ComponentGroupRef Id="ElectronDllComponents" />
      <ComponentGroupRef Id="ElectronResourceComponents" />
      <ComponentGroupRef Id="ResourceComponents" />
      <ComponentGroupRef Id="RendererComponents" />
      <ComponentGroupRef Id="LocalesComponents" />
      <ComponentRef Id="PathEnvironment" />
      <ComponentRef Id="RegistryEntries" />
      <ComponentRef Id="ProgramMenuShortcuts" />
      <ComponentRef Id="DesktopShortcut" />
    </Feature>
    
    <!-- ============================================ -->
    <!-- UI -->
    <!-- ============================================ -->
    
    <!-- Custom UI: Skip license and verification screens -->
    <UI>
      <ui:WixUI Id="WixUI_InstallDir" InstallDirectory="INSTALLDIR" />
      
      <!-- Override default: Welcome goes directly to InstallDir (skip license) -->
      <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="99" />
      
      <!-- Override default: InstallDir Next triggers installation (skip VerifyReady) -->
      <Publish Dialog="InstallDirDlg" Control="Next" Event="EndDialog" Value="Return" Order="99" />
      
      <!-- Override default: InstallDir Back goes to Welcome (skip license) -->
      <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="99" />

      <!-- On ExitDialog, run Lemonade when user clicks Finish with checkbox checked -->
      <Publish Dialog="ExitDialog"
               Control="Finish"
               Event="DoAction"
               Value="LaunchApplication"
               Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1" />
    </UI>
    
    <!-- Custom branding images -->
    <!-- WixUIDialogBmp = 493×312 left-side banner for welcome/finish screens -->
    <WixVariable Id="WixUIDialogBmp" Value="$(var.SourceDir)\installer\installer_banner_wix.bmp" />
    
    <!-- WixUIBannerBmp = 493×58 top banner with lemon icon (replaces red CD) -->
    <WixVariable Id="WixUIBannerBmp" Value="$(var.SourceDir)\installer\top_banner.bmp" />
    
    <!-- ============================================ -->
    <!-- Custom Actions -->
    <!-- ============================================ -->
    
    <!-- Stop the C++ NSIS server before uninstalling it, wait for processes to fully terminate -->
    <CustomAction Id="StopNsisServer"
                  Directory="SystemFolder"
                  ExeCommand='[SystemFolder]cmd.exe /c if exist "[NSISINSTALLED]\bin\lemonade-server.exe" ("[NSISINSTALLED]\bin\lemonade-server.exe" stop &amp; ping 127.0.0.1 -n 3 &gt;nul)'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check" />
    
    <!-- If a legacy C++ NSIS-based installer exists, run its uninstaller and wait for it to complete.
         The uninstaller may take time to delete large caches, so we wait 10 seconds using ping. -->
    <CustomAction Id="RunNsisUninstall"
                  Directory="SystemFolder"
                  ExeCommand='[SystemFolder]cmd.exe /c ""[NSISUNINSTALLSTRING]" /S &amp; echo Cleaning up legacy Lemonade_Server_Installer.exe installation... &amp; ping 127.0.0.1 -n 11 &gt;nul &amp; if exist "[NSISINSTALLED]" (echo ERROR: Directory still exists after uninstall &amp; dir "[NSISINSTALLED]" &amp; exit /b 1) else (echo Legacy uninstall succeeded &amp; exit /b 0)"'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="check" />
    
    <!-- Stop server before upgrade using lemonade-server stop from existing MSI install -->
    <!-- This properly stops all child processes (router, llama-server, etc.) -->
    <CustomAction Id="StopServerCmd"
                  Directory="SystemFolder"
                  ExeCommand='[SystemFolder]cmd.exe /c "[EXISTINGINSTALLDIR]bin\lemonade-server.exe" stop'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore" />
    
    <!-- Stop legacy Python-based server from the previous Python NSIS install in INSTALLDIR -->
    <CustomAction Id="StopLegacyPythonServer"
                  Directory="SystemFolder"
                  ExeCommand='[SystemFolder]cmd.exe /c if exist "[INSTALLDIR]bin\lemonade-server.bat" "[INSTALLDIR]bin\lemonade-server.bat" stop'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore" />
    
    <!-- Clean legacy Python-based install directory in INSTALLDIR before MSI takes over -->
    <CustomAction Id="CleanLegacyInstall"
                  Directory="INSTALLDIR"
                  ExeCommand='[SystemFolder]cmd.exe /c rmdir /s /q "[INSTALLDIR]"'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore" />
    
    <!-- Launch Lemonade.exe (triggered from ExitDialog Finish button) by shell-executing
         the Start Menu shortcut through explorer.exe. This ensures the process runs in the
         normal user context with the shortcut-defined working directory. -->
    <CustomAction Id="LaunchApplication"
                  Directory="SystemFolder"
                  ExeCommand='"[SystemFolder]explorer.exe" "[ProgramMenuDir]Lemonade.lnk"'
                  Impersonate="yes"
                  Return="asyncNoWait" />
    
    <!-- Stop server during uninstall -->
    <CustomAction Id="StopServerOnUninstall"
                  Directory="BinDir"
                  ExeCommand='cmd.exe /c "lemonade-server.exe stop"'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore" />
    
    <!-- Clean up runtime-created directories during uninstall (ryzenai-server and llama folders).
         These folders are created at runtime when models are downloaded, so WiX doesn't track them. -->
    <CustomAction Id="CleanupRuntimeDirs"
                  Directory="BinDir"
                  ExeCommand='cmd.exe /c "rmdir /s /q ryzenai-server &amp; rmdir /s /q llama"'
                  Execute="immediate"
                  Impersonate="yes"
                  Return="ignore" />
    
    <!-- Copy Electron renderer files (bulk copy of ~580 files) -->
    <CustomAction Id="CopyRendererFiles"
                  Directory="ResourcesDir"
                  ExeCommand='cmd.exe /c "robocopy /E /NFL /NDL /NJH /NJS /nc /ns /np "$(var.SourceDir)\build\Release\resources\dist\renderer" "[ResourcesDir]dist\renderer" || exit /b 0"'
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />
    
    <InstallExecuteSequence>
      <!-- If NSIS-based C++ installer is present, stop the server first, then uninstall -->
      <Custom Action="StopNsisServer"
              Before="RunNsisUninstall"
              Condition="NSISUNINSTALLSTRING AND NOT Installed" />
      
      <Custom Action="RunNsisUninstall"
              Before="StopLegacyPythonServer"
              Condition="NSISUNINSTALLSTRING AND NOT Installed" />
      
      <!-- Stop legacy Python-based server from the previous Python NSIS install before cleaning its files.
           Only runs if lemonade-server.bat exists (evidence of Python install). -->
      <Custom Action="StopLegacyPythonServer"
              Before="CleanLegacyInstall"
              Condition="NOT Installed AND NOT NSISUNINSTALLSTRING" />
      
      <!-- Remove any legacy Python-based install tree in INSTALLDIR (Python NSIS layout).
           Only runs if we already stopped the Python server (which only runs if .bat exists). -->
      <Custom Action="CleanLegacyInstall"
              Before="InstallValidate"
              Condition="NOT Installed AND NOT NSISUNINSTALLSTRING" />
      
      <!-- Stop server from an existing MSI-based C++ install before validation -->
      <Custom Action="StopServerCmd"
              Before="InstallValidate"
              Condition="EXISTINGINSTALLDIR AND (EXISTINGINSTALLDIR &lt;&gt; &quot;&quot;)" />
      
      <!-- Stop server during uninstall before cleaning up runtime directories -->
      <Custom Action="StopServerOnUninstall"
              Before="CleanupRuntimeDirs"
              Condition="Installed AND REMOVE=&quot;ALL&quot;" />
      
      <!-- Clean up runtime-created directories during uninstall -->
      <Custom Action="CleanupRuntimeDirs"
              Before="RemoveFiles"
              Condition="Installed AND REMOVE=&quot;ALL&quot;" />
      
      <!-- Copy renderer files after installing other files -->
      <Custom Action="CopyRendererFiles"
              After="InstallFiles"
              Condition="NOT Installed" />
    </InstallExecuteSequence>
    
  </Package>

</Wix>

