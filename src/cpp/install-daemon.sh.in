#!/bin/bash

set -e

APP_PATH="/Applications/Lemonade.app"
EXECUTABLE_NAME="@EXECUTABLE_NAME@"
PLIST_SRC="${APP_PATH}/Contents/Resources/com.lemonade.server.plist"
PLIST_DEST="$HOME/Library/LaunchAgents/com.lemonade.server.plist"
CONFIG_SRC="${APP_PATH}/Contents/Resources/config.default.json"
CONFIG_DEST="$HOME/Library/Application Support/Lemonade/config.json"
CONFIG_DIR="$HOME/Library/Application Support/Lemonade"
LOG_DIR="$HOME/Library/Logs"

echo "Installing Lemonade as a user service..."
echo "This runs as your user account."

# Create directories
mkdir -p "$CONFIG_DIR"
mkdir -p "$LOG_DIR"

# Create log files
touch "$LOG_DIR/lemonade-server.out.log"
touch "$LOG_DIR/lemonade-server.err.log"
chmod 644 "$LOG_DIR/lemonade-server."*.log

# Install config file
if [ ! -f "$CONFIG_DEST" ]; then
    cp "$CONFIG_SRC" "$CONFIG_DEST"
    chmod 644 "$CONFIG_DEST"
    echo "Default configuration installed to $CONFIG_DEST"
else
    echo "Existing config found at $CONFIG_DEST — leaving unchanged."
    echo "   (Edit it manually to customize port, backend, etc.)"
fi

# Install and configure the LaunchAgent plist
cp "$PLIST_SRC" "$PLIST_DEST"

sed -i '' "s|@APP_PATH@|${APP_PATH}|g" "$PLIST_DEST"
sed -i '' "s|@EXECUTABLE_NAME@|${EXECUTABLE_NAME}|g" "$PLIST_DEST"

chmod 644 "$PLIST_DEST"

# Load the service
launchctl load -w "$PLIST_DEST"

echo ""
echo "Lemonade server is now running as a user service!"
echo "• Configuration: $CONFIG_DEST"
echo "• Logs: $LOG_DIR/lemonade-server.out.log and .err.log"
echo ""
echo "To restart after config changes:"
echo "  launchctl unload -w $PLIST_DEST"
echo "  launchctl load -w $PLIST_DEST"
echo ""
echo "To uninstall:"
echo "  launchctl unload -w $PLIST_DEST"
echo "  rm $PLIST_DEST"
echo "  rm -rf $CONFIG_DIR"
