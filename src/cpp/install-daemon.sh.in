#!/bin/bash

set -e

APP_PATH="/Applications/Lemonade.app"
EXECUTABLE_NAME="@EXECUTABLE_NAME@"
PLIST_SRC="${APP_PATH}/Contents/Resources/com.lemonade.server.plist"
PLIST_DEST="/Library/LaunchDaemons/com.lemonade.server.plist"
CONFIG_SRC="${APP_PATH}/Contents/Resources/config.default.json"
CONFIG_DEST="/etc/lemonade/config.json"
CONFIG_DIR="/etc/lemonade"

echo "Installing Lemonade as a system-wide service..."
echo "This requires administrator privileges."

# Create log files
sudo touch /var/log/lemonade-server.out.log
sudo touch /var/log/lemonade-server.err.log
sudo chmod 644 /var/log/lemonade-server.*.log

# Install config file
sudo mkdir -p "$CONFIG_DIR"

if [ ! -f "$CONFIG_DEST" ]; then
    sudo cp "$CONFIG_SRC" "$CONFIG_DEST"
    sudo chmod 644 "$CONFIG_DEST"
    echo "Default configuration installed to $CONFIG_DEST"
else
    echo "Existing config found at $CONFIG_DEST — leaving unchanged."
    echo "   (Edit it manually to customize port, backend, etc.)"
fi

# Install and configure the LaunchDaemon plist
sudo cp "$PLIST_SRC" "$PLIST_DEST"

sudo sed -i '' "s|@APP_PATH@|${APP_PATH}|g" "$PLIST_DEST"
sudo sed -i '' "s|@EXECUTABLE_NAME@|${EXECUTABLE_NAME}|g" "$PLIST_DEST"

sudo chown root:wheel "$PLIST_DEST"
sudo chmod 644 "$PLIST_DEST"

# Load the service
sudo launchctl load -w "$PLIST_DEST"

echo ""
echo "Lemonade server is now running as a system service!"
echo "• Configuration: $CONFIG_DEST"
echo "• Logs: /var/log/lemonade-server.out.log and .err.log"
echo ""
echo "To restart after config changes:"
echo "  sudo launchctl unload -w $PLIST_DEST"
echo "  sudo launchctl load -w $PLIST_DEST"
echo ""
echo "To uninstall:"
echo "  sudo launchctl unload -w $PLIST_DEST"
echo "  sudo rm $PLIST_DEST"
echo "  sudo rm -rf $CONFIG_DIR"